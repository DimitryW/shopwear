<!DOCTYPE html>
<html>

<head>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>SHOPWEAR</title>
    <link rel="stylesheet" type="text/css" href="../static/mainstyle.css">

</head>

<body id="body">
    <div class="page_container">
        <div class="page-wrapper">
            <div class="topnav-container ">
                <div class="topnav">
                    <a id="nav-title" href="/" style="margin: 0;">SHOPWEAR</a>
                    <button class="nav-item1" id="nav-item1"><a id="nav-item1-a" style="text-decoration: none;"></a></button>
                    <div id="cart-item" style="display: none;"></div>
                    <button class="nav-item2" id="nav-item2"><a id="nav-item2-a" style="text-decoration: none;" href="https://www.dimalife.com/login"></a></button>
                    <select class="mem-dropdown" id="mem-dropdown" onchange="if (this.selectedIndex==2) logout(); if (this.selectedIndex==1) location = this.value;">
                        <option value="" disabled selected></option>
                        <option id="drowpdown-mem-info" value="member"><a id="drowpdown-mem-info-a" href="https://www.dimalife.com/member">會員資料</a></option>
                        <option id="dropdown-logout">登出</option>
                    </select>
                </div>
            </div>

            <div class="main-container" id="main-container">
                <div class="product-container">
                    <div id="product"></div>
                    <div id="product-desc">
                        <form>
                            <div class="payment-info">
                                <div style="font-size: 19px; font-weight: 700; margin: 44px 0px 24px 0px;">付款資訊</div>
                                <div class="form-group card-number-group">
                                    <label for="card-number" class="control-label">卡片號碼： </label>
                                    <div name="card-number" class="form-control card-number"></div>
                                </div>
                                <div class="form-group expiration-date-group">
                                    <label for="expiration-date" class="control-label">過期時間： </label>
                                    <div name="expiration-date" class="form-control expiration-date" id="tappay-expiration-date"></div>
                                </div>
                                <div class="form-group cvc-group" style="margin-bottom: 43px;">
                                    <label for="cvc" class="control-label">驗證密碼： </label>
                                    <div name="" cvc "" class="form-control cvc"></div>
                                </div>
                                <div id="card-err-msg" style="display: none; font-size: 19px; color: red;">信用卡資料不正確，請重新輸入</div>
                                <div id="total-price">總價：新台幣 <span></span> 元</div><br>
                                <button id="confirm-button" type="submit" class="btn btn-default">確認訂購並付款</button>
                            </div>
                        </form>
                    </div>

                </div>



                <div class="product-detail-container">
                    <div class="product-detail" id="product-detail">

                    </div>
                </div>

            </div>
        </div>
        <div class="footer-container">
            <div id="footer">SHOPWEAR</div>
        </div>

        <div id="end"></div>
    </div>

    <script type="text/javascript" src="../static/script/script.js"></script>
    <script>
        window.onload = () => {
            showProductDetail();
            loggedIn();
            showCart();
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://js.tappaysdk.com/tpdirect/v5.9.0"></script>
    <script>
        TPDirect.setupSDK(124007, 'app_X8jtqiiGoJSvEyhpZcog4DuLrqIfrmbbPHty7vQPS9gGdnqmmzeNtChLM5rA', 'sandbox')
        TPDirect.card.setup({
            fields: {
                number: {
                    element: '.form-control.card-number',
                    placeholder: '**** **** **** ****'
                },
                expirationDate: {
                    element: document.getElementById('tappay-expiration-date'),
                    placeholder: 'MM / YY'
                },
                ccv: {
                    element: $('.form-control.cvc')[0],
                    placeholder: 'CVV'
                }
            },
            styles: {
                'input': {
                    'color': 'gray'
                },
                'input': {
                    'font-size': '16px'

                },
                ':focus': {
                    'color': 'black'
                },
                '.valid': {
                    'color': 'green'
                },
                '.invalid': {
                    'color': 'red'
                },
                '@media screen and (max-width: 400px)': {
                    'input': {
                        'color': 'orange'
                    }
                }
            }
        })
        TPDirect.card.onUpdate(function(update) {
            if (update.canGetPrime) {
                $('button[type="submit"]').removeAttr('disabled')
            } else {
                $('button[type="submit"]').attr('disabled', true)
            }
        })
        $('form').on('submit', function(event) {
            event.preventDefault()
            let name = document.getElementById("contact-name").value;
            let email = document.getElementById("contact-email").value;
            let number = document.getElementById("contact-number").value;
            let emailRegex = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,8})$/;
            let numberRegex = /^09[0-9]{8}$/;
            if (name === "" | email === "" | number === "") {
                document.getElementById("contact-err-msg").style.display = "block";
                document.getElementById("card-err-msg").style.display = "none";
                return
            } else {
                document.getElementById("contact-err-msg").style.display = "none";
            }
            if (!emailRegex.test(email)) {
                document.getElementById("contact-err-msg").innerHTML = "請輸入正確信箱格式";
                document.getElementById("contact-err-msg").style.display = "block";
                document.getElementById("card-err-msg").style.display = "none";
                return;
            }
            if (!numberRegex.test(number)) {
                document.getElementById("contact-err-msg").innerHTML = "請輸入正確手機號碼格式";
                document.getElementById("contact-err-msg").style.display = "block";
                document.getElementById("card-err-msg").style.display = "none";
                return;
            }

            const tappayStatus = TPDirect.card.getTappayFieldsStatus()
            console.log(tappayStatus)

            // Check TPDirect.card.getTappayFieldsStatus().canGetPrime before TPDirect.card.getPrime
            if (tappayStatus.canGetPrime === false) {
                // alert('can not get prime')
                document.getElementById("card-err-msg").style.display = "block";
                document.getElementById("contact-err-msg").style.display = "none";
                return
            }

            // Get prime
            TPDirect.card.getPrime(function(result) {
                if (result.status !== 0) {
                    // alert('get prime error ' + result.msg)
                    document.getElementById("card-err-msg").style.display = "block";
                    return
                }
                document.getElementById("card-err-msg").style.display = "none";
                confirmBooking();
                send_order(result.card.prime);
            })
        })
    </script>
</body>

</html>